Most C2 frameworks, including Cobalt Strike, are capable of producing ready-to-run payloads in formats such as `.exe`, `.dll`, `.ps1`, and more.  However, there are situations, such as initial access, where it's beneficial to build your own payloads utilising raw shellcode.  The aim of this chapter is to provide you with a foundation for understanding the PE file structure, processes, and how various injection techniques are performed.

### PE File Structure
The portable executable (PE) file format holds information necessary about a program for the operating system to load it into memory.  Both `.exe` and `.dll` files are PEs.
![[Pasted image 20250623104400.png]]

## DOS header

The DOS header is a fixed 64-byte structure, called `IMAGE_DOS_HEADER`, that exists at the start of every PE file.  Most of the members are not used anymore, but the two important ones are:

- #### e_magic
    
    This is the first member and is a 2-byte WORD.  This value is always **4D 5A**, or **MZ** in ASCII.  It's simply a signature that marks the beginning of the PE.
    
- #### e_lfanew
    
    This is the last member and is a 4-byte LONG.  It contains an offset to the PE signature at the start of the NT headers.  Because it's the last member, it is always located at an offset of **3C** (60 in decimal) from the start of the PE file.
![[Pasted image 20250623104617.png]]
## DOS stub
The DOS stub is only used when the PE file is executed under MS-DOS, which simply prints the message "This program cannot be run in DOS mode".  The modern Windows loader uses the offset in `e_lfanew` to skip over this stub and go directly to the NT headers (described below).

![[Pasted image 20250626103149.png]]

## NT headers
The Windows SDK (software development kit) has two definitions for the NT header - `IMAGE_NT_HEADERS` for 32-bit PEs and `IMAGE_NT_HEADERS64` for 64-bit PEs.

- #### PE signature
    
    Like the e_magic member of the DOS header, the PE signature is a 4-byte DWORD that always has a fixed value of **50 45 00 00** which is **PE\0\0** in ASCII.  This is used to verify that the start of the NT header has been correctly located.
    
- #### File header
    
    The file header is a structure called `IMAGE_FILE_HEADER`, which has 7 members.  Some key ones are:
    
    - **Machine** - a 2-byte WORD that indicates the CPU architecture the PE is compiled for.  The possible values are documented [here](https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#machine-types).
	    - **Constant:** `IMAGE_FILE_MACHINE_AMD64` 
	    - **Value:** `0x8664` 
	    - **Description:** `x64`
    - **NumberOfSections** - a WORD that holds the number of sections the PE has (described below).
    - **SizeOfOptionalHeader** - a 2-byte WORD that holds the size of the optional header.
    - **Characteristics** - a 2-byte flag that describes some [attributes](https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#characteristics) of the PE.

![[Pasted image 20250626103638.png]]

- #### Optional header
    
    The optional header structure can either be `IMAGE_OPTIONAL_HEADER32` or `IMAGE_OPTIONAL_HEADER64` depending on the PE architecture.  Some key members include:
    
    - **Magic** - a value that determines whether the image is PE32 (i.e. 32-bit) or PE32+ (i.e. 64-bit).
    - **AddressOfEntryPoint** - the address of the PE's entry point relative to the image base when loaded into memory.
    - **ImageBase** - the preferred base address for the PE image to be loaded into.
    - **NumberOfRvaAndSizes** - the size of the _DataDirectory_ array.
    - **DataDirectory** - an array of `IMAGE_DATA_DIRECTORY` structures.
![[Pasted image 20250626104054.png]]
### Data directories

The `IMAGE_DATA_DIRECTORY` structure contains two members.  A _VirtualAddress_, which points to the start of a particular data directory structure; and a _Size_, which is the size of that data directory.  These data directories contain information needed by the Windows loader, for example, the import directory contains details of the modules (DLLs) that that PE requires to function.

## Sections

The PE sections contain the actual data and executable code of the program.  These typically include:

- **.text** - contains the executable code of the program.
- **.data** - contains initialised data. 
- **.bss** - contains uninitialised data.
- **.rdata** - contains read-only data.
- **.rsrc** - contains resources used by the program such as icons, images, etc.
    

Each section is appended to the a header that describes it.  A section header contains a:

- **Name** - the name of the section.  This field is limited to 8-bytes.
- **VirtualSize** - the total size of the section when loaded into memory.
- **VirtualAddress** - the memory address of the section when loaded into memory.  The value is an offset relative to the image's base address.
- **SizeOfRawData** - the size of the section as it is stored on disk.  This size may be different to its virtual size, e.g. if it's padded.
- **Characteristics** - a set of flags that describe the characteristics of the section.  One such characteristic is the final memory permissions that this section memory should be (e.g. R, RW, RX, etc).